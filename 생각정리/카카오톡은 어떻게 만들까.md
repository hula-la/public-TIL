# 카카오톡은 어떻게 만들었을까?

### 개요

 개츠비라는 프로젝트에서 1대1 채팅을 만든 적이 있다. 이 때의 요구사항은 다음과 같았다.

- 게임에 접속했을 때, 오프라인 상태에 쌓였거나 기존에 읽지 않은 메시지의 갯수가 친구 아이디 옆에 표시되어야 한다.
- 온라인 상태일 때, 메시지가 오면 실시간으로 표시가 되어야 한다.
- 채팅을 읽으면 읽지 않은 메시지의 갯수가 0이 된다.

이 요구사항들을 구현하는 것은 생각보다 쉽게 했다. 하지만 구현에만 초점을 맞추느라, 놓친 것들이 너무 많았다. 먼저 어떻게 구현했는지에 대해 적자면 다음과 같다.

- **읽음 유무 저장: **  메시지를 보내면 읽지 않음의 상태로 데이터베이스에 저장한다.
- **접속했을 때 오프라인 상태에서 쌓였던 메시지와 이전 메시지들을 보기 위해:** 사용자가 게임에 접속하면, 친구 id를 key로 하고 그와의 대화 리스트를 value로 가지는 딕셔너리를 주는데, 프론트엔드에서 안 읽은 메시지를 카운팅해서 사용자 화면에 띄어준다.
- **온라인 상태에서 실시간으로 메시지를 받기 위해:** 메시지를 보내면 상대 유저 id의 토픽으로 메시지를 전달한다. 온라인 상태에서 사용자들은 자신의 id로 개인 구독을 하고 있기 때문에 메시지를 바로 확인할 수 있다.
- **채팅을 읽으면 메시지를 읽었다고 표시해주기 위해:** 채팅방에 들어가면, 안읽음 메시지들의 id 리스트를 서버로 전달하여, db에서 메시지들의 상태를 변경한다. 채팅방에 들어간 상태일 때는 메시지를 받을 때마다 읽음 상태로 변경한다.

이 구현 방법에 대한 문제점과 해결방법에 대해서 생각해봤다.

1. **네트워크 비용**: 게임에 접속할 때마다 모든 메시지를 가져오도록 구현했었다. 이미 이전에 불러왔던 메시지들도 게임을 껐을 때 초기화됐다가, 접속할 때마다 다시 요청하여 받는다. 캐싱을 이용하면 중복된 데이터 요청을 방지할 수 있지만, 게임서비스에서의 채팅이 캐싱되어야 할 정도로 중요한 데이터일까 싶기도 하다. 그리고, 시간이 부족해서 구현을 안한거긴한데, 페이지네이션을 하면 데이터의 양이 줄어들어서 네트워크 비용을 절약할 수 있을 것이다. 
2. **저장공간 낭비**: 사용자들의 채팅을 저장할 필요가 있을까? 저장공간 낭비와 프라이버시 침해 차원에서 이게 맞나 라는 의구심이 든다. 카카오톡을 참고하자면, 데이터를 3일동안 저장해둔다. 평소에는 휴대폰 백그라운드로 메시지를 전송받아 폰에 저장해두고, 폰이 꺼져있거나 앱이 완전 종료되어 있을 경우 3일 내로 다시 접속했을 때 쌓인 데이터를 동기화한다. 이 방법 좀 괜찮을지도,,?
3. **성능**: 현재의 로직은 안 읽은 메시지들을 카운팅해서 알려주고, 읽으면 모든 메시지를 하나씩 읽음 표시해준다. 현재와 같이 대용량 데이터가 아닐 때는 빠르게 수행되지만, 메시지가 1억개가 넘는 대용량이 된다면? 음.. 그런데 O(N)의 시간복잡도니까 1초에 1억,, 괜찮으려나,,? 이걸 생각하다보니 카카오톡에서 메시지 읽은 사람 수 기능이 어떻게 구현되었을지 궁금해졌다. 메시지를 따로 db에 저장하는게 아니니까 사람들의 수를 역카운팅하는 것도 아닐텐데,, 갑자기 생각난 2가지 방법은 다음과 같다.
   - 사람들마다 그 방에 들어온 마지막 시간들을 기록해둔다. 이건 실시간성이 필요하니까 소켓통신일 것이다. 사람들의 마지막 접속 시간을 정렬해둔다. 그리고 메시지 데이터는 클라이언트에게 있을테니까, 읽은 사람 수는 화면 렌더링 때 표시를 해줘야하기 때문에 사람들의 접속 시간에 대한 데이터는 클라이언트에게 보내는 것이 좋을 것이다. 그리고 읽은 사람 수는 그 메시지보다 더 늦게 들어온 사람의 수를 세서 출력하면 된다. 기존에 읽은 사람 수를 다 업데이트하면 너무 부하가 많이 들지 않을까 생각했는데, 클라이언트에서 관리하면 화면이 감지될 때만 그 수를 갱신하면 되기 때문에 성능 문제가 없을 것이다. 마지막 접속 시간을 정렬하는 것은 수를 셀 때마다 for문으로 스캔할 필요을 줄이기 위함인데, 이로 인해서 추가해줘야할 세부적인 로직들이 있을 것이다. 다음에 한 번 직접 구현해봐야징..!



역시 분석하는건 재미따,, 이게 옳은지 틀린지 모른다. 사실 틀릴 확률이 크겠징,,? 더 머찐 개발자로 성장해보자^_^

